<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Words</title>
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="manifest" href="./site.webmanifest">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Balsamiq Sans for a kid-friendly look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Balsamiq Sans', cursive;
            background: linear-gradient(to bottom right, #1d2b53, #2f2e51, #0c0b1f);
            color: #d1d2ff;
        }
        .container-bg {
            background-color: rgba(30, 41, 59, 0.85); /* Dark blue with transparency */
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }
        .btn-game {
            transform: scale(1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-game:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-level {
            background-color: #556080;
            color: #e0eaff;
        }
        .btn-mode {
            background-color: #5d5d81;
            color: #f1f2ff;
        }
        .btn-answer {
            background-color: #8f7bff;
            color: #3b2d74;
        }
        .btn-correct {
            animation: bounce-in 0.5s ease-out;
        }
        .btn-incorrect {
            animation: shake 0.5s ease-out;
        }
        .modal {
            background: rgba(0, 0, 0, 0.7);
        }
        .star-shine {
            animation: pulse 1s infinite;
        }
        [disabled] {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        @keyframes bounce-in {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        #wordToTypeContainer {
            min-height: 8rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main App Container -->
    <div id="mainContent" class="container-bg rounded-[3rem] p-8 md:p-12 w-full max-w-4xl min-h-[70vh] flex flex-col items-center text-center relative shadow-xl">

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="flex flex-col items-center justify-center p-8 h-full w-full transition-opacity duration-500">
             <div id="welcomeScreenContent" class="flex flex-col items-center justify-center h-full w-full">
                <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-8 leading-tight">üöÄ&nbsp;Rocket&nbsp;Words!&nbsp;‚≠ê</h1>
                <p class="text-lg md:text-xl text-gray-300 mb-10 max-w-md">Let's learn some new words! Are you ready for an adventure?</p>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="startBtn" class="btn-game px-8 py-4 rounded-full text-2xl font-bold text-white bg-blue-500 hover:bg-blue-600 transition-colors duration-300">Start üöÄ</button>
                </div>
            </div>
            <!-- Parent Mode Cog Icon -->
            <button id="parentCogBtn" class="absolute bottom-4 left-4 p-4 rounded-full text-gray-400 bg-gray-700 hover:bg-gray-600 transition-colors text-3xl">‚öôÔ∏è</button>
        </div>

        <!-- Parent Login Screen -->
        <div id="parentLoginScreen" class="hidden flex flex-col items-center justify-center p-8 h-full w-full transition-opacity duration-500">
            <h2 class="text-3xl md:text-4xl font-extrabold text-purple-400 mb-6">Parent Mode</h2>
            <p class="text-lg text-gray-400 mb-4">What's this number?</p>
            <p id="numberAsWords" class="text-xl font-bold mb-4 text-white"></p>
            <div class="w-full max-w-xs text-center">
                <p id="numeralPlaceholder" class="text-4xl font-extrabold text-purple-400 tracking-widest mb-4">___</p>
                <div id="numeralPad" class="grid grid-cols-3 gap-2">
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="1">1</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="2">2</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="3">3</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="4">4</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="5">5</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="6">6</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="7">7</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="8">8</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="9">9</button>
                    <button class="btn-game px-6 py-4 text-lg rounded-lg bg-red-500 hover:bg-red-600 col-span-1" id="clearBtn">Clear</button>
                    <button class="numeral-btn btn-game btn-mode px-6 py-4 text-2xl rounded-lg" data-digit="0">0</button>
                </div>
            </div>
            <p id="parentLoginError" class="text-red-400 text-sm mt-4"></p>
            <div class="flex gap-4 mt-4">
                <button id="backFromParentLoginBtn" class="btn-game px-6 py-3 rounded-full text-lg font-bold text-gray-400 bg-gray-700 hover:bg-gray-600 transition-colors">Cancel</button>
            </div>
        </div>

        <!-- Parent Mode Screen -->
        <div id="parentModeScreen" class="hidden flex flex-col items-center justify-start p-8 h-full w-full transition-opacity duration-500 overflow-y-auto">
            <h2 class="text-3xl md:text-4xl font-extrabold text-blue-400 mb-6">Manage Words & Levels</h2>
            
            <!-- Add/Remove Level Section -->
            <div class="w-full max-w-lg mb-6 flex flex-col md:flex-row gap-2 items-center">
                <input type="text" id="newLevelNameInput" placeholder="New Level Name" class="flex-grow px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500 text-lg bg-gray-800 text-white w-full md:w-auto">
                <button id="addLevelBtn" class="btn-game px-6 py-3 rounded-full text-lg font-bold text-white bg-green-500 hover:bg-green-600 transition-colors w-full md:w-auto">Add Level</button>
            </div>
            
            <!-- Select/Edit Level Section -->
            <div class="w-full max-w-lg mb-6">
                <div class="flex gap-2 items-center mb-2">
                    <label for="parentLevelSelect" class="block text-xl font-bold">Select Level:</label>
                    <button id="removeLevelBtn" class="btn-game px-4 py-2 rounded-full text-sm font-bold text-white bg-red-500 hover:bg-red-600 transition-colors">Remove</button>
                </div>
                <select id="parentLevelSelect" class="w-full p-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500 text-center text-lg bg-gray-800 text-white"></select>
            </div>
            
            <!-- Edit Level Name Section -->
            <div class="w-full max-w-lg mb-6 flex flex-col md:flex-row gap-2 items-center">
                <input type="text" id="levelNameInput" placeholder="Edit Level Name" class="flex-grow px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500 text-lg bg-gray-800 text-white w-full md:w-auto">
                <button id="saveLevelNameBtn" class="btn-game px-6 py-3 rounded-full text-lg font-bold text-white bg-blue-500 hover:bg-blue-600 transition-colors w-full md:w-auto">Save Name</button>
            </div>

            <!-- Manage Words Section -->
            <div class="w-full max-w-lg mb-6">
                <h3 class="text-xl font-bold mb-2">Current Words:</h3>
                <div id="wordListContainer" class="bg-gray-800 p-4 rounded-xl border-2 border-dashed border-gray-600 min-h-[100px] max-h-64 overflow-y-auto">
                    <!-- Words will be populated here -->
                </div>
            </div>
            <div class="w-full max-w-lg mb-6 flex flex-col md:flex-row gap-2 items-center">
                <input type="text" id="newWordInput" placeholder="Add new word" class="flex-grow px-4 py-3 rounded-lg border-2 border-gray-600 focus:outline-none focus:border-blue-500 text-lg bg-gray-800 text-white w-full md:w-auto">
                <button id="addWordBtn" class="btn-game px-6 py-3 rounded-full text-lg font-bold text-white bg-green-500 hover:bg-green-600 transition-colors w-full md:w-auto">Add Word</button>
            </div>
            <button id="backFromParentModeBtn" class="btn-game px-6 py-2 rounded-full text-sm font-bold text-gray-400 bg-gray-700 hover:bg-gray-600 transition-colors mt-4">Done</button>
        </div>


        <!-- Level Selection Screen -->
        <div id="levelScreen" class="hidden flex flex-col items-center justify-center p-8 h-full w-full transition-opacity duration-500">
            <h2 class="text-3xl md:text-4xl font-extrabold text-purple-400 mb-8">Choose your adventure!</h2>
            <div id="levelContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-xl mb-8">
                <!-- Level buttons generated by JS -->
            </div>
            <button id="backFromLevelBtn" class="btn-game px-6 py-2 rounded-full text-sm font-bold text-gray-400 bg-gray-700 hover:bg-gray-600 transition-colors">Go Back ‚Ü©Ô∏è</button>
        </div>

        <!-- Mode Selection Screen -->
        <div id="modeScreen" class="hidden flex flex-col items-center justify-center p-8 h-full w-full transition-opacity duration-500">
            <h2 class="text-3xl md:text-4xl font-extrabold text-purple-400 mb-8">How do you want to play?</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-2xl mb-8">
                <button id="listenModeBtn" class="btn-game btn-mode px-6 py-8 rounded-2xl text-2xl font-bold hover:scale-105">
                    <span class="text-4xl mb-2">üëÇ</span><br>Listen
                </button>
                <button id="readModeBtn" class="btn-game btn-mode px-6 py-8 rounded-2xl text-2xl font-bold hover:scale-105">
                    <span class="text-4xl mb-2">üìñ</span><br>Read
                </button>
                <button id="typeModeBtn" class="btn-game btn-mode px-6 py-8 rounded-2xl text-2xl font-bold hover:scale-105">
                    <span class="text-4xl mb-2">‚úçÔ∏è</span><br>Write
                </button>
            </div>
            <button id="backFromModeBtn" class="btn-game px-6 py-2 rounded-full text-sm font-bold text-gray-400 bg-gray-700 hover:bg-gray-600 transition-colors">Go Back ‚Ü©Ô∏è</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden flex flex-col items-center justify-center p-8 h-full w-full transition-opacity duration-500">
            <div class="flex justify-between items-center w-full max-w-xl mb-6">
                <h2 id="modeTitle" class="text-3xl font-bold text-gray-300"></h2>
                <span id="scoreDisplay" class="text-2xl font-bold text-green-400">Score: 0</span>
            </div>
            
            <!-- Listen & Tap Mode -->
            <div id="listenMode" class="hidden flex flex-col items-center justify-center w-full">
                <button id="listenRepeatBtn" class="btn-game btn-mode p-4 rounded-full mb-8">
                    <span class="text-6xl">üîä</span>
                </button>
                <div id="wordOptions" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-xl">
                    <!-- Buttons will be generated here by JavaScript -->
                </div>
            </div>

            <!-- Read the Word Mode -->
            <div id="readMode" class="hidden flex flex-col items-center justify-center w-full">
                <div class="p-8 bg-gray-800 rounded-3xl w-full max-w-2xl text-center mb-8 shadow-md cursor-pointer">
                    <p id="wordToRead" class="text-5xl md:text-7xl font-extrabold text-blue-400 uppercase"></p>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="iSaidItBtn" class="btn-game btn-answer px-8 py-4 rounded-full text-2xl font-bold text-white bg-green-500 hover:bg-green-600 transition-colors">
                        I said it! üéâ
                    </button>
                    <button id="nextQuestionBtn" class="btn-game btn-mode px-8 py-4 rounded-full text-2xl font-bold text-white bg-purple-500 hover:bg-purple-600 transition-colors">
                        Next Word ‚û°Ô∏è
                    </button>
                </div>
            </div>

            <!-- Type the Word Mode -->
            <div id="typeMode" class="hidden flex flex-col items-center justify-center w-full">
                <div class="flex flex-col items-center w-full max-w-xl">
                    <div class="p-8 bg-gray-800 rounded-3xl w-full text-center mb-8 shadow-md">
                        <p id="wordToType" class="text-5xl md:text-7xl font-extrabold text-blue-400 uppercase mb-4"></p>
                        <p id="typedWord" class="text-3xl md:text-5xl font-extrabold text-purple-400 uppercase p-2 min-h-[4rem]"></p>
                    </div>
                </div>
                <div id="letterButtonsContainer" class="flex flex-wrap justify-center gap-2 mt-4"></div>
                <div class="flex flex-col md:flex-row gap-4 mt-8">
                     <button id="typeRepeatBtn" class="btn-game btn-mode p-4 rounded-full">
                        <span class="text-6xl">üîä</span>
                    </button>
                </div>
            </div>
            
            <button id="backFromGameBtn" class="btn-game absolute bottom-4 left-4 px-6 py-2 rounded-full text-sm font-bold text-gray-400 bg-gray-700 hover:bg-gray-600 transition-colors">Go Back ‚Ü©Ô∏è</button>
        </div>
        
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal hidden fixed inset-0 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-3xl p-8 text-center shadow-xl transform transition-transform scale-95 duration-300">
            <span id="correctStar" class="star-shine text-7xl mb-4 hidden">üåü</span>
            <p id="feedbackMessage" class="text-4xl font-extrabold mb-6 text-green-400"></p>
            <div class="flex gap-4 justify-center">
                <button id="nextBtn" class="btn-game px-8 py-4 rounded-full text-xl font-bold text-white bg-blue-500 hover:bg-blue-600 transition-colors">
                    Next One!
                </button>
                <button id="tryAgainBtn" class="btn-game px-8 py-4 rounded-full text-xl font-bold text-white bg-red-500 hover:bg-red-600 transition-colors hidden">
                    Try Again
                </button>
            </div>
        </div>
    </div>
    <!-- App Logic -->
    <script>
        const data = {
            levels: {
                level1: { name: 'Level 1', words: ['the', 'am', 'we', 'look', 'i', 'is', 'to', 'here', 'mum', 'in'] },
                level2: { name: 'Level 2', words: ['dad', 'can', 'on', 'see', 'went', 'me', 'up', 'at', 'and', 'go'] }
            },
            currentWord: null,
            lastWord: null,
            score: 0,
            mode: null,
            currentWordList: [],
            currentLevelName: '',
        };

        const screens = {
            welcome: document.getElementById('welcomeScreen'),
            parentLogin: document.getElementById('parentLoginScreen'),
            parentMode: document.getElementById('parentModeScreen'),
            level: document.getElementById('levelScreen'),
            mode: document.getElementById('modeScreen'),
            game: document.getElementById('gameScreen')
        };
        const scoreDisplay = document.getElementById('scoreDisplay');
        const wordToReadDisplay = document.getElementById('wordToRead');
        const modeTitle = document.getElementById('modeTitle');
        const wordOptionsContainer = document.getElementById('wordOptions');
        const levelSelect = document.getElementById('parentLevelSelect');
        const levelNameInput = document.getElementById('levelNameInput');
        const newLevelNameInput = document.getElementById('newLevelNameInput');
        const removeLevelBtn = document.getElementById('removeLevelBtn');
        const wordListContainer = document.getElementById('wordListContainer');
        const newWordInput = document.getElementById('newWordInput');
        const numeralPlaceholder = document.getElementById('numeralPlaceholder');
        const numberAsWordsDisplay = document.getElementById('numberAsWords');
        const parentLoginError = document.getElementById('parentLoginError');
        const listenRepeatBtn = document.getElementById('listenRepeatBtn');
        const typeRepeatBtn = document.getElementById('typeRepeatBtn');
        const wordToTypeDisplay = document.getElementById('wordToType');
        const typedWordDisplay = document.getElementById('typedWord');
        const letterButtonsContainer = document.getElementById('letterButtonsContainer');

        let isParentLoggedIn = false;
        let typedWordState = '';
        let typedWordPlaceholder = [];
        let challengeNumber = 0;
        let numeralState = '';

        let audioContext;
        let synthesizer = window.speechSynthesis;
        let voice;

        const showScreen = (screenName) => {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        };

        const updateScoreDisplay = () => {
            scoreDisplay.textContent = `Score: ${data.score}`;
        };

        const saveAppStatus = () => {
            localStorage.setItem('rocketWordsData', JSON.stringify(data));
        };

        const loadAppData = () => {
            const savedData = JSON.parse(localStorage.getItem('rocketWordsData'));
            if (savedData) {
                Object.assign(data, savedData);
            }
            data.score = 0;
            updateScoreDisplay();
            updateLevelButtons();
        };

        const updateLevelButtons = () => {
            const levelContainer = document.getElementById('levelContainer');
            levelContainer.innerHTML = '';
            
            for (const key in data.levels) {
                const button = document.createElement('button');
                button.id = `${key}Btn`;
                button.classList.add('btn-game', 'btn-level', 'px-6', 'py-4', 'rounded-2xl', 'text-xl', 'font-bold', 'hover:scale-105');
                button.textContent = data.levels[key].name;
                button.addEventListener('click', () => handleLevelSelect(key));
                levelContainer.appendChild(button);
            }

            // Add "All Levels" button at the end
            const allLevelsBtn = document.createElement('button');
            allLevelsBtn.id = 'allLevelsBtn';
            allLevelsBtn.classList.add('btn-game', 'px-6', 'py-4', 'rounded-2xl', 'text-xl', 'font-bold', 'hover:scale-105', 'bg-blue-500', 'hover:bg-blue-600');
            allLevelsBtn.textContent = 'All Levels';
            allLevelsBtn.addEventListener('click', () => handleLevelSelect('all-levels'));
            levelContainer.appendChild(allLevelsBtn);
        };

        const generateChallenge = () => {
            challengeNumber = Math.floor(Math.random() * 900) + 100;
            numberAsWordsDisplay.textContent = numberToWords(challengeNumber);
            numeralState = '';
            numeralPlaceholder.textContent = '___';
            parentLoginError.textContent = '';
        };

        const numberToWords = (n) => {
            if (n === 0) return "zero";
            const units = ["", "one", "two", "three", "four", "five", "six", "seven", "eight", "nine"];
            const teens = ["ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen", "sixteen", "seventeen", "eighteen", "nineteen"];
            const tens = ["", "", "twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty", "ninety"];

            let words = "";

            // Hundreds
            if (n >= 100) {
                words += units[Math.floor(n / 100)] + " hundred";
                n %= 100;
                if (n > 0) words += " and ";
            }

            // Tens and Units
            if (n >= 20) {
                words += tens[Math.floor(n / 10)];
                n %= 10;
                if (n > 0) words += "-" + units[n];
            } else if (n >= 10) {
                words += teens[n - 10];
            } else if (n > 0) {
                words += units[n];
            }
            return words.trim();
        };

        const handleParentLogin = () => {
            const numeral = parseInt(numeralState, 10);
            if (numeralState.length === 3 && numeral === challengeNumber) {
                isParentLoggedIn = true;
                showScreen('parentMode');
                renderParentModeUI();
            } else {
                parentLoginError.textContent = 'Incorrect number. Please try again.';
                generateChallenge();
            }
        };

        const handleNumeralTap = (digit) => {
            if (numeralState.length < 3) {
                numeralState += digit;
                numeralPlaceholder.textContent = numeralState.padEnd(3, '_').split('').join(' ');

                if (numeralState.length === 3) {
                    handleParentLogin();
                }
            }
        };

        const handleNumeralClear = () => {
            numeralState = '';
            numeralPlaceholder.textContent = '___';
        };

        const renderParentModeUI = (selectedLevelKey = null) => {
            levelSelect.innerHTML = '';
            let levelKeys = Object.keys(data.levels);
            if (levelKeys.length === 0) {
                levelSelect.innerHTML = '<option value="">No Levels</option>';
            } else {
                for (const key in data.levels) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = data.levels[key].name;
                    levelSelect.appendChild(option);
                }
            }
            
            // Set the level selector to the previously selected level, if it still exists
            if (selectedLevelKey && data.levels[selectedLevelKey]) {
                levelSelect.value = selectedLevelKey;
            } else {
                // Otherwise, default to the first level
                levelSelect.value = levelKeys[0];
            }
            
            // Enable/disable the remove level button
            removeLevelBtn.disabled = levelKeys.length <= 1;

            updateParentWordList();
        };

        const updateParentWordList = () => {
            const selectedLevel = levelSelect.value;
            const words = data.levels[selectedLevel] ? data.levels[selectedLevel].words : [];
            const levelName = data.levels[selectedLevel] ? data.levels[selectedLevel].name : '';
            levelNameInput.value = levelName;
            wordListContainer.innerHTML = '';
            words.forEach((word) => {
                const item = document.createElement('div');
                item.classList.add('flex', 'justify-between', 'items-center', 'p-2', 'bg-gray-700', 'rounded-lg', 'mb-2', 'text-gray-200');
                item.innerHTML = `
                    <span>${word}</span>
                    <button class="text-red-400 hover:text-red-300 font-bold" data-word="${word}">Remove</button>
                `;
                wordListContainer.appendChild(item);
            });
        };

        const handleAddLevel = () => {
            const newName = newLevelNameInput.value.trim();
            if (newName) {
                const newKey = `level_${Date.now()}`;
                data.levels = { ...data.levels, [newKey]: { name: newName, words: [] } };
                newLevelNameInput.value = '';
                saveAppStatus();
                updateLevelButtons();
                renderParentModeUI(newKey);
            }
        };

        const handleRemoveLevel = () => {
            const selectedLevel = levelSelect.value;
            if (Object.keys(data.levels).length > 1) {
                delete data.levels[selectedLevel];
                saveAppStatus();
                updateLevelButtons();
                renderParentModeUI();
            }
        };

        const handleSaveLevelName = () => {
            const selectedLevel = levelSelect.value;
            const newName = levelNameInput.value.trim();
            if (newName && data.levels[selectedLevel]) {
                data.levels[selectedLevel].name = newName;
                saveAppStatus();
                updateLevelButtons();
                renderParentModeUI(selectedLevel);
            }
        };

        const handleAddWord = () => {
            const selectedLevel = levelSelect.value;
            const newWord = newWordInput.value.trim().toLowerCase();
            if (newWord && data.levels[selectedLevel] && !data.levels[selectedLevel].words.includes(newWord)) {
                data.levels[selectedLevel].words.push(newWord);
                newWordInput.value = '';
                saveAppStatus();
                updateParentWordList();
            }
        };

        const handleRemoveWord = (wordToRemove) => {
            const selectedLevel = levelSelect.value;
            if (!data.levels[selectedLevel]) return;
            const index = data.levels[selectedLevel].words.indexOf(wordToRemove);
            if (index > -1) {
                data.levels[selectedLevel].words.splice(index, 1);
                saveAppStatus();
                updateParentWordList();
            }
        };

        const handleLevelSelect = (levelKey) => {
            if (levelKey === 'all-levels') {
                data.currentLevelName = 'All Levels';
                data.currentWordList = Object.values(data.levels).reduce((acc, level) => acc.concat(level.words), []);
            } else {
                data.currentLevelName = data.levels[levelKey].name;
                data.currentWordList = data.levels[levelKey].words;
            }
            // Reset last word when changing levels
            data.lastWord = null;
            showScreen('mode');
        };

        const handleModeSelect = (mode) => {
            data.mode = mode;
            document.getElementById('listenMode').classList.add('hidden');
            document.getElementById('readMode').classList.add('hidden');
            document.getElementById('typeMode').classList.add('hidden');

            if (data.mode === 'listen') {
                modeTitle.textContent = `${data.currentLevelName} - Listen`;
                document.getElementById('listenMode').classList.remove('hidden');
                startListenAndTap();
            } else if (data.mode === 'read') {
                modeTitle.textContent = `${data.currentLevelName} - Read`;
                document.getElementById('readMode').classList.remove('hidden');
                startReadTheWord();
            } else if (data.mode === 'write') {
                modeTitle.textContent = `${data.currentLevelName} - Write`;
                document.getElementById('typeMode').classList.remove('hidden');
                startTypeTheWord();
            }
            showScreen('game');
        };

        const formatWord = (word) => {
            return word.toLowerCase() === 'i' ? 'I' : word.toUpperCase();
        };

        const startReadTheWord = () => {
            const wordList = data.currentWordList;
            if (wordList.length === 0) {
                wordToReadDisplay.textContent = 'ADD WORDS IN PARENT MODE!';
                return;
            }
            
            let randomIndex;
            let newWord;
            do {
                randomIndex = Math.floor(Math.random() * wordList.length);
                newWord = wordList[randomIndex];
            } while (newWord === data.lastWord && wordList.length > 1);

            data.currentWord = newWord;
            data.lastWord = newWord;
            
            wordToReadDisplay.textContent = formatWord(data.currentWord);
            wordToReadDisplay.onclick = () => playWord(data.currentWord);
        };

        const playCorrectSound = () => {
            try {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.value = 880;
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + 0.01);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.5);

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.error("Audio playback failed:", e);
            }
        };

        const playWord = (word) => {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(word);
                if (voice) {
                    utterance.voice = voice;
                }
                utterance.rate = 0.6;
                utterance.pitch = 1.2;
                synthesizer.speak(utterance);
            }
        };

        const startListenAndTap = () => {
            wordOptionsContainer.innerHTML = '';
            const wordList = data.currentWordList;
            if (wordList.length === 0) {
                wordOptionsContainer.innerHTML = '<p class="text-xl">ADD WORDS IN PARENT MODE!</p>';
                return;
            }

            let newWord;
            do {
                newWord = wordList[Math.floor(Math.random() * wordList.length)];
            } while (newWord === data.lastWord && wordList.length > 1);

            data.currentWord = newWord;
            data.lastWord = newWord;

            const allWords = [...wordList];
            const shuffledOptions = allWords.sort(() => 0.5 - Math.random());
            const options = shuffledOptions.slice(0, 4);
            if (!options.includes(data.currentWord)) {
                options[Math.floor(Math.random() * options.length)] = data.currentWord;
            }
            options.sort(() => 0.5 - Math.random());

            options.forEach(word => {
                const button = document.createElement('button');
                button.textContent = formatWord(word);
                button.setAttribute('data-word', word);
                button.classList.add('btn-game', 'btn-answer', 'p-6', 'rounded-xl', 'text-2xl', 'font-bold', 'uppercase', 'transition-all', 'duration-200', 'transform', 'hover:scale-105', 'active:scale-95', 'w-full', 'md:w-auto');
                button.addEventListener('click', () => handleTapAnswer(word, button));
                wordOptionsContainer.appendChild(button);
            });

            setTimeout(() => playWord(data.currentWord), 500);
            listenRepeatBtn.onclick = () => playWord(data.currentWord);
        };

        const handleTapAnswer = (selectedWord, button) => {
            const isCorrect = selectedWord === data.currentWord;

            if (isCorrect) {
                data.score += 10;
                updateScoreDisplay();
                saveAppStatus();
                // playCorrectSound();
                button.classList.add('btn-correct');
                document.querySelectorAll('#wordOptions button').forEach(btn => btn.disabled = true);
                showFeedback('Correct!', isCorrect);
            } else {
                button.classList.add('btn-incorrect');
                button.disabled = true;
                showFeedback('Oops, try again!', isCorrect);
            }
        };

        const startTypeTheWord = () => {
            typedWordState = '';
            const wordList = data.currentWordList;
            if (wordList.length === 0) {
                wordToTypeDisplay.textContent = 'ADD WORDS IN PARENT MODE!';
                return;
            }

            let newWord;
            do {
                newWord = wordList[Math.floor(Math.random() * wordList.length)];
            } while (newWord === data.lastWord && wordList.length > 1);
            
            data.currentWord = newWord;
            data.lastWord = newWord;

            wordToTypeDisplay.textContent = formatWord(data.currentWord);
            typedWordPlaceholder = Array(data.currentWord.length).fill('_');
            typedWordDisplay.textContent = typedWordPlaceholder.join(' ');
            
            letterButtonsContainer.innerHTML = '';
            const uniqueLetters = [...new Set(data.currentWord.split(''))];
            const shuffledLetters = uniqueLetters.sort(() => 0.5 - Math.random());
            
            shuffledLetters.forEach(letter => {
                const button = document.createElement('button');
                button.textContent = formatWord(letter);
                button.setAttribute('data-letter', letter);
                button.classList.add('btn-game', 'btn-answer', 'px-6', 'py-4', 'rounded-xl', 'text-3xl', 'font-bold', 'hover:scale-110');
                button.addEventListener('click', () => handleLetterTap(letter));
                letterButtonsContainer.appendChild(button);
            });

            playWord(data.currentWord);
            typeRepeatBtn.onclick = () => playWord(data.currentWord);
        };

        const handleLetterTap = (letter) => {
            const nextLetter = data.currentWord[typedWordState.length];

            if (letter === nextLetter) {
                typedWordState += letter;
                typedWordPlaceholder[typedWordState.length - 1] = formatWord(letter);
                typedWordDisplay.textContent = typedWordPlaceholder.join(' ');
                
                if (data.currentWord === typedWordState) {
                    data.score += 10;
                    updateScoreDisplay();
                    saveAppStatus();
                    // playCorrectSound();
                    document.querySelectorAll('#letterButtonsContainer button').forEach(btn => btn.disabled = true);
                    showFeedback('You got it!', true);
                }
            } else {
                typedWordState = '';
                typedWordPlaceholder = Array(data.currentWord.length).fill('_');
                typedWordDisplay.textContent = typedWordPlaceholder.join(' ');
                showFeedback(`Oops, try again!`, false);
            }
        };

        const showFeedback = (message, isCorrect) => {
            const modal = document.getElementById('feedbackModal');
            const messageElement = document.getElementById('feedbackMessage');
            messageElement.textContent = message;
            modal.classList.remove('hidden');

            const starIcon = document.getElementById('correctStar');
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            starIcon.classList.toggle('hidden', !isCorrect);
            tryAgainBtn.classList.toggle('hidden', isCorrect);
            nextBtn.classList.toggle('hidden', !isCorrect);
        };

        const hideFeedback = () => {
            const modal = document.getElementById('feedbackModal');
            modal.classList.add('hidden');
        };

        const handleNextQuestion = () => {
            hideFeedback();
            if (data.mode === 'listen') {
                startListenAndTap();
            } else if (data.mode === 'read') {
                startReadTheWord();
            } else if (data.mode === 'write') {
                startTypeTheWord();
            }
        };
        
        const init = () => {
            loadAppData();

            synthesizer.onvoiceschanged = () => {
                const voices = synthesizer.getVoices();
                voice = voices.find(v => v.name.includes('Google') && v.lang.startsWith('en')) ||
                        voices.find(v => v.name.includes('Microsoft') && v.lang.startsWith('en')) ||
                        voices.find(v => v.lang.startsWith('en-AU')) ||
                        voices.find(v => v.lang.startsWith('en-NZ')) ||
                        voices.find(v => v.lang.startsWith('en-GB')) ||
                        voices.find(v => v.lang.startsWith('en-US')) ||
                        voices.find(v => v.lang.startsWith('en'));
            };

            // Event listeners
            document.getElementById('startBtn').addEventListener('click', () => showScreen('level'));
            document.getElementById('parentCogBtn').addEventListener('click', () => {
                showScreen('parentLogin');
                generateChallenge();
            });
            document.getElementById('backFromLevelBtn').addEventListener('click', () => {
                updateScoreDisplay();
                showScreen('welcome');
            });
            document.getElementById('backFromModeBtn').addEventListener('click', () => {
                updateScoreDisplay();
                showScreen('level');
            });
            document.getElementById('backFromGameBtn').addEventListener('click', () => {
                updateScoreDisplay();
                showScreen('mode');
            });
            document.getElementById('iSaidItBtn').addEventListener('click', () => {
                data.score += 10;
                updateScoreDisplay();
                saveAppStatus();
                showFeedback('Awesome!', true);
            });
            document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                hideFeedback();
                startReadTheWord();
            });
            document.getElementById('nextBtn').addEventListener('click', handleNextQuestion);
            document.getElementById('tryAgainBtn').addEventListener('click', hideFeedback);
            
            // Parent Mode UI listeners
            document.getElementById('addLevelBtn').addEventListener('click', handleAddLevel);
            document.getElementById('removeLevelBtn').addEventListener('click', handleRemoveLevel);
            document.getElementById('addWordBtn').addEventListener('click', handleAddWord);
            document.getElementById('parentLevelSelect').addEventListener('change', updateParentWordList);
            document.getElementById('saveLevelNameBtn').addEventListener('click', handleSaveLevelName);

            document.getElementById('wordListContainer').addEventListener('click', (e) => {
                if (e.target.dataset.word) {
                    handleRemoveWord(e.target.dataset.word);
                }
            });

            // Number pad listeners
            document.getElementById('numeralPad').addEventListener('click', (e) => {
                if (e.target.matches('.numeral-btn')) {
                    handleNumeralTap(e.target.dataset.digit);
                }
            });
            document.getElementById('clearBtn').addEventListener('click', handleNumeralClear);
            
            // Event listeners for mode selection buttons
            document.getElementById('listenModeBtn').addEventListener('click', () => handleModeSelect('listen'));
            document.getElementById('readModeBtn').addEventListener('click', () => handleModeSelect('read'));
            document.getElementById('typeModeBtn').addEventListener('click', () => handleModeSelect('write'));

            document.getElementById('backFromParentModeBtn').addEventListener('click', () => {
                isParentLoggedIn = false;
                data.score = 0;
                updateScoreDisplay();
                showScreen('welcome');
            });
            document.getElementById('backFromParentLoginBtn').addEventListener('click', () => showScreen('welcome'));
        };

        window.onload = init;
    </script>

</body>
</html>
